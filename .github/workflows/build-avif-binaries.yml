name: Build AVIF binaries

on:
  push:
    branches:
      - '**'
  workflow_dispatch: # Allows manual triggering  

jobs:
  freebsd:
    runs-on: ${{matrix.os}}
    timeout-minutes: 65
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm]
    steps:
      - name: Checkout repository locally
        uses: actions/checkout@v5
        with:
          submodules: true
      - name: Get relevant env variable names
        id: envnames
        run: |
            envs=$(printenv \
              | cut -d= -f1 \
              | grep -E '^(GITHUB|CI|ALLOW|KEY|API|Disable|Git)' \
              | grep -v '^GITHUB_WORKSPACE$' \
              | sort \
              | tr '\n' ' ')
            echo "envs=$envs" >> "$GITHUB_OUTPUT"
      - name: Get Arch
        id: get-arch
        run: |
          arch=$(uname -m)
          echo "arch=$arch" >> "$GITHUB_OUTPUT"
      - name: Setup FreeBSD VM
        id: vm
        uses: vmactions/freebsd-vm@v1
        with:
          envs: ${{ steps.envnames.outputs.envs }}
          arch: ${{ steps.get-arch.outputs.arch }}
          # usesh: true
          sync: sshfs
          prepare: |
            pkg install -y bash sudo
            chsh -s /usr/local/bin/bash
            ln -sf /usr/local/bin/gmake /usr/bin/make
            pw useradd runner -u 1001 -m -s /usr/local/bin/bash
            pw groupmod wheel -m runner
            echo "runner ALL=(ALL) NOPASSWD: ALL" > /usr/local/etc/sudoers.d/runner
            chmod 440 /usr/local/etc/sudoers.d/runner
            chown -R runner:runner "$GITHUB_WORKSPACE"
            chmod g+s "$GITHUB_WORKSPACE"

      - name: Install dependencies
        uses: ./.github/actions/install-avif-deps
        with:
          shell: freebsd {0}
      - name: Build
        id: build-avif
        uses: ./.github/actions/build-avif
        with:
          shell: freebsd {0}

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: FreeBSD-${{ steps.build-avif.outputs.arch }}
          path: ${{steps.build-avif.outputs.artifacts}}
          if-no-files-found: error
  alpine:
    runs-on: ${{matrix.os}}
    timeout-minutes: 65
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm]
    steps:
      - name: Checkout repository locally
        uses: actions/checkout@v5
        with:
          submodules: true
      - name: Setup Alpine Linux
        uses: bgilbert/setup-alpine@aarch64
        with:
          packages: sudo bash
      - name: Install dependencies
        uses: ./.github/actions/install-avif-deps
        with:
          shell: alpine.sh {0}
      - name: Build
        id: build-avif
        uses: ./.github/actions/build-avif
        with:
          shell: alpine.sh {0}

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{runner.os}}-${{ steps.build-avif.outputs.arch }}-musl
          path: ${{steps.build-avif.outputs.artifacts}}
          if-no-files-found: error
  build:
    runs-on: ${{matrix.os}}
#    container: ${{matrix.container}}
    timeout-minutes: 65
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-24.04, ubuntu-24.04-arm, macos-26, macos-15-intel, windows-2025, windows-11-arm ]
    steps:
      - name: Checkout repository locally
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Install dependencies
        uses: ./.github/actions/install-avif-deps
        
      - name: Build 
        id: build-avif
        uses: ./.github/actions/build-avif

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{runner.os}}-${{ steps.build-avif.outputs.arch }}
          path: ${{steps.build-avif.outputs.artifacts}}
          if-no-files-found: error
  nuget:
    runs-on: ubuntu-latest
    timeout-minutes: 65
    needs: [build, alpine, freebsd]
    steps:
      - name: Checkout repository locally
        uses: actions/checkout@v5
        with:
          submodules: true
      - uses: actions/download-artifact@v6
        with:
          path: artifacts
      - name: Organize artifacts into runtime layout
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p output/native

          # Helper to detect if ELF uses musl
          is_musl() {
            local f="$1"
            if file "$f" 2>/dev/null | grep -q ELF; then
              if readelf -l "$f" 2>/dev/null | grep -q musl; then
                return 0
              fi
            fi
            return 1
          }

          for dir in artifacts/*; do
            [ -d "$dir" ] || continue
            name="$(basename "$dir")"
            os="$(echo "$name" | cut -d- -f1 | tr '[:upper:]' '[:lower:]')"
            arch="$(echo "$name" | cut -d- -f2 | tr '[:upper:]' '[:lower:]')"

            # Determine runtime identifier family
            case "$os" in
              windows) rid_family="windows" ;;
              macos)   rid_family="osx" ;;
              linux)
                # try to detect musl if any ELF file inside says so
                if find "$dir" -type f -exec file {} + | grep -q ELF; then
                  first_elf="$(find "$dir" -type f -exec file {} + | grep ELF | head -n1 | cut -d: -f1)"
                  if [ -n "$first_elf" ] && is_musl "$first_elf"; then
                    rid_family="linux-musl"
                  else
                    rid_family="linux"
                  fi
                else
                  rid_family="linux"
                fi
                ;;
              *) rid_family="${os,,}" ;;
            esac

            dest="output/native/${rid_family}/${arch}"
            mkdir -p "$dest"
            mv "$dir"/* "$dest/"
          done
      - name: Show organized output structure
        run: tree output/native || find output/native
      - name: Pack Nuget
        run: "dotnet pack -c Release -o nuget"
      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: Nuget
          path: nuget/**.nupkg
          if-no-files-found: error